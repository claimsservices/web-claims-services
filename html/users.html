<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/"
  data-template="vertical-menu-template-free">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>ST - User Management</title>
  <meta name="description" content="" />
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/3P4.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->
      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo d-flex align-items-center justify-content-between px-3 py-3"
            style="background-color: #f9f8f4; border-bottom: 1px solid #e5e5e5;">
            <div class="d-flex align-items-center">
              <a href="dashboard.html" class="app-brand-link d-flex align-items-center">
                <span class="app-brand-logo demo me-3">
                  <img src="..\assets\img\elements\3P4.jpg" alt="Logo" width="60" style="object-fit: contain;">
                </span>
              </a>
              <div style="line-height: 1.3;">
                <div style="font-size: 0.9rem; color: #a68b64; font-weight: 400; margin-bottom: 2px;">
                  Welcome to
                </div>
                <div style="font-size: 0.95rem; color: #b38e5d; font-weight: 600;">
                  ST Application
                </div>
              </div>
            </div>
            <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large d-block d-xl-none ms-auto">
              <i class="bx bx-chevron-left bx-sm align-middle" style="color: #b38e5d;"></i>
            </a>
          </div>
        <div class="menu-inner-shadow"></div>
        <ul class="menu-inner py-1">
          <li class="menu-item">
            <a href="dashboard.html" class="menu-link">
              <i class="menu-icon icon-base bx bx-home-circle"></i>
              <div data-i18n="Analytics">Dashboard</div>
            </a>
          </li>
          <li class="menu-item active open">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon icon-base bx bx-user"></i>
              <div data-i18n="Layouts">User Management</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item active" id="admin-menu">
                <a href="users.html" class="menu-link">
                  <div data-i18n="Without menu">Administrator</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="account.html" class="menu-link">
                  <div data-i18n="Without navbar">Account Settings</div>
                </a>
              </li>
            </ul>
          </li>
        </ul>
        <div class="menu-footer mt-auto p-3 border-top">
          <div class="d-flex flex-column align-items-start">
            <span id="appVersion" class="text-muted small mb-2"></span>
            <a href="javascript:void(0)" class="btn btn-sm btn-outline-danger w-100" id="logout-menu">
              <i class="bx bx-log-out-circle me-1"></i> Logout
            </a>
          </div>
        </div>
      </aside>
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>
          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow d-flex align-items-center gap-3" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img id="userAvatar" src="../assets/img/avatars/A1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                  <div class="text-start">
                    <span class="fw-semibold d-block" id="user-info"></span>
                    <small class="text-muted" id="user-role"></small>
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="account.html">
                      <i class="bx bx-user me-2"></i>
                      <span class="align-middle">My Profile</span>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" id="logout">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">Log Out</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="card">
              <div class="card-header border-bottom">
                <h5 class="card-title mb-3">Search Users</h5>
                <div class="row align-items-center g-3">
                  <div class="col-md-4">
                    <div class="d-flex">
                      <input type="search" class="form-control" id="dt-search-0" placeholder="Search User" />
                      <button id="search-btn" class="btn btn-secondary ms-2">Search</button>
                    </div>
                  </div>
                  <div class="col-md-4 ms-auto d-flex justify-content-end">
                    <button id="new-user-btn" class="btn rounded-pill btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddUser">
                      <span><i class="icon-base bx bx-plus icon-sm me-0 me-sm-2"></i><span class="d-none d-sm-inline-block">Add New User</span></span>
                    </button>
                  </div>
                </div>
              </div>
              <div class="table-responsive text-nowrap">
                <table class="table">
                  <thead class="table-dark">
                    <tr>
                      <th>Username</th>
                      <th>Mobile</th>
                      <th>Role</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="userTableBody" class="table-border-bottom-0"></tbody>
                </table>
              </div>
            </div>
          </div>
          <footer class="content-footer footer bg-footer-theme"></footer>
          <div class="content-backdrop fade"></div>
        </div>
        <!-- / Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>
    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
  </div>
  <!-- / Layout wrapper -->

  <!-- Offcanvas for Adding New User -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAddUser" aria-labelledby="offcanvasAddUserLabel">
    <div class="offcanvas-header border-bottom py-4">
      <h5 id="offcanvasAddUserLabel" class="offcanvas-title text-uppercase fw-bold">Add User</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body mx-0 p-4">
      <form class="add-new-user pt-0" id="addNewUserForm">
        <div class="mb-4">
          <label class="form-label" for="add-user-username">Username <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="add-user-username" required>
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-password">Password <span class="text-danger">*</span></label>
          <input type="password" class="form-control" id="add-user-password" required>
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-confirm-password">Confirm Password <span class="text-danger">*</span></label>
          <input type="password" class="form-control" id="add-user-confirm-password" required>
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-name">First Name</label>
          <input type="text" class="form-control" id="add-user-name">
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-surename">Last Name</label>
          <input type="text" class="form-control" id="add-user-surename">
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-email">Email <span class="text-danger">*</span></label>
          <input type="email" id="add-user-email" class="form-control" required>
        </div>
        <div class="mb-4">
          <label class="form-label" for="add-user-contact">Contact <span class="text-danger">*</span></label>
          <input type="text" id="add-user-contact" class="form-control" required>
        </div>
        <div class="mb-4">
          <label class="form-label" for="user-role-regist">User Role</label>
          <select id="user-role-regist" class="form-select" required>
            <option value="">Select Roles</option>
            <option value="Officer">Officer</option>
            <option value="Admin Officer">Admin Officer</option>
            <option value="Leader">Leader</option>
            <option value="Sales Manager">Sales Manager</option>
            <option value="Operation Manager">Operation Manager</option>
            <option value="Director">Director</option>
          </select>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Core JS -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="../assets/vendor/js/bootstrap.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/js/main.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- Constants ---
      const API_BASE_URL = 'https://be-claims-service.onrender.com/api';
      const LOGIN_PAGE = '../index.html';
      const DASHBOARD_PAGE = 'dashboard.html';

      // --- JWT and Auth Functions ---
      const accessToken = localStorage.getItem('authToken');

      function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
          return JSON.parse(jsonPayload);
        } catch (e) {
          console.error('Failed to decode JWT:', e);
          return null;
        }
      }

      function logout() {
        localStorage.removeItem('authToken');
        window.location.href = LOGIN_PAGE;
      }

      // --- Page Initialization ---
      function initializePage() {
        // 1. Authentication and Authorization Check
        if (!accessToken) {
          window.location.href = LOGIN_PAGE;
          return; // Stop execution if not logged in
        }

        const decodedToken = parseJwt(accessToken);
        if (!decodedToken) {
          logout();
          return;
        }

        const userRole = decodedToken.role;
        const allowedRoles = ['Director', 'Operation Manager'];
        if (!allowedRoles.includes(userRole)) {
          alert('You do not have permission to access this page.');
          window.location.href = DASHBOARD_PAGE;
          return; // Stop execution if not authorized
        }

        // 2. Setup UI and Event Listeners
        setupUI(decodedToken);
        setupEventListeners();

        // 3. Fetch Initial Data
        fetchUsers();
      }

      // --- UI Setup ---
      function setupUI(decodedToken) {
        document.getElementById('user-info').innerText = `${decodedToken.first_name || ''} ${decodedToken.last_name || ''}`;
        document.getElementById('user-role').innerText = decodedToken.role || '';
        const userAvatar = document.getElementById('userAvatar');
        if (decodedToken.myPicture) {
            userAvatar.src = decodedToken.myPicture;
        } else {
            userAvatar.src = '../assets/img/avatars/A1.png'; // Default avatar
        }

        fetch('/version.json')
          .then(res => res.json())
          .then(data => {
            document.getElementById("appVersion").textContent = `App Version ${data.version}`;
          }).catch(() => {
            document.getElementById("appVersion").textContent = "App Version -";
          });
      }

      // --- Event Listeners ---
      function setupEventListeners() {
        document.getElementById('logout').addEventListener('click', logout);
        document.getElementById('logout-menu').addEventListener('click', logout);
        document.getElementById('addNewUserForm').addEventListener('submit', handleAddUser);
        document.getElementById('userTableBody').addEventListener('click', handleDeleteUser);
      }

      // --- Data Fetching ---
      async function fetchUsers() {
        try {
          const response = await fetch(`${API_BASE_URL}/user-management/users`, {
            method: 'GET',
            headers: { 'Authorization': accessToken },
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch users: ${response.status}`);
          }

          const data = await response.json();
          populateTable(data.results);
        } catch (error) {
          console.error('Error fetching users:', error);
          alert('Could not load user data. Please try again.');
        }
      }

      // --- DOM Manipulation ---
      function populateTable(users) {
        const tableBody = document.getElementById('userTableBody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (!users || users.length === 0) {
            // Optionally, display a message in the table
            const row = tableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 5;
            cell.textContent = 'No users found.';
            cell.style.textAlign = 'center';
            return;
        }

        users.forEach((user) => {
          const row = tableBody.insertRow();
          row.innerHTML = `
            <td>
              <div class="d-flex align-items-center">
                <img src="${user.profile_picture || '../assets/img/avatars/A1.png'}" alt="Avatar" class="rounded-circle" width="30" />
                <div class="ms-3">
                  <strong>${user.username}</strong><br />
                  <small>${user.email || ''}</small>
                </div>
              </div>
            </td>
            <td>${user.phone || ''}</td>
            <td><i class="icon-base bx bx-user text-success me-2"></i>${user.role}</td>
            <td>
              <span class="badge ${user.is_active ? 'bg-label-success' : 'bg-label-secondary'}">
                ${user.is_active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <button class="btn btn-icon delete-record" data-username="${user.username}">
                  <i class="icon-base bx bx-trash icon-md"></i>
                </button>
              </div>
            </td>
          `;
        });
      }

      // --- Event Handlers ---
      async function handleAddUser(e) {
        e.preventDefault();
        const password = document.getElementById("add-user-password").value;
        const confirmPassword = document.getElementById("add-user-confirm-password").value;
        const email = document.getElementById("add-user-email").value;

        if (password !== confirmPassword) {
          alert("Passwords do not match!");
          return;
        }
        
        const userData = {
          username: document.getElementById("add-user-username").value,
          password: password,
          email: email,
          first_name: document.getElementById("add-user-name").value,
          last_name: document.getElementById("add-user-surename").value,
          phone: document.getElementById("add-user-contact").value,
          role: document.getElementById("user-role-regist").value,
        };

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': accessToken 
                },
                body: JSON.stringify(userData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to add user');
            }
            
            alert('User added successfully!');
            document.getElementById("addNewUserForm").reset();
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasAddUser'));
            offcanvas.hide();
            fetchUsers(); // Refresh the table
        } catch (error) {
            console.error('Error adding user:', error);
            alert(`Failed to add user: ${error.message}`);
        }
      }

      async function handleDeleteUser(event) {
        const deleteButton = event.target.closest('.delete-record');
        if (!deleteButton) return;

        const username = deleteButton.dataset.username;
        if (!username) return;

        if (!confirm(`Are you sure you want to delete the user: ${username}?`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/user-management/delete-user`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': accessToken,
                },
                body: JSON.stringify({ username }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete user');
            }

            alert('User deleted successfully.');
            fetchUsers(); // Refresh the table
        } catch (error) {
            console.error('Error deleting user:', error);
            alert(`Failed to delete user: ${error.message}`);
        }
      }

      // --- Start the application ---
      initializePage();
    });
  </script>
</body>
</html>
